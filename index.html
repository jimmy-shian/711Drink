<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>711 飲料紀杯平台 - 管理員介面</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
  :root{ --base-bg:#f2f5f3; }
  body{ background-color:var(--base-bg); }
    body { padding-top: 40px; }
    .hide { display:none; }
    /* Hover effects for all buttons */
    .btn:hover, .btn:focus {
      transform: translateY(-1px);
      box-shadow: 0 .25rem .5rem rgba(0,0,0,.15);
      transition: all .3s ease-in-out;
    }
    /* Skeleton loading */
    .skeleton{background-color:#6c757d33;border-radius:4px;animation:pulse 1.5s infinite;}
    @keyframes pulse{0%{opacity:1;}50%{opacity:.4;}100%{opacity:1;}}
  </style>
</head>
<body>
<div class="container">
  <!-- 提示訊息 -->
  <div id="msg" class="alert hide" role="alert" style="z-index: 2000;"></div>
  <!-- 使用者列 -->
  <div id="userBar" class="d-flex justify-content-end align-items-center mb-3 hide">
    <span id="userLabel" role="button" class="badge bg-info text-dark rounded-5 p-3" 
    style="cursor:pointer; box-shadow: 0px 2px 2px rgba(0,0,0,0.1); margin-right: 1rem;"data-bs-toggle="modal" data-bs-target="#editAdminModal" title="點擊修改個人資料"></span>
    <button class="btn btn-sm btn-outline-secondary d-none" id="logoutBtn" onclick="logout()">登出</button>
  </div>

  <!-- 登入 / 註冊 卡片 -->
  <div id="authCard" class="card mx-auto" style="max-width:400px;">
    <div class="card-body">
      <h5 class="card-title text-center mb-3" id="authTitle">管理員登入</h5>

      <div class="mb-3">
        <label for="username" class="form-label">帳號</label>
        <input type="text" class="form-control" id="username" required>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">密碼</label>
        <input type="password" class="form-control" id="password" required>
      </div>
      <!-- 驗證碼 (註冊時) -->
      <div class="mb-3 hide" id="vcodeGroup">
        <label for="verifyCode" class="form-label">驗證碼</label>
        <input type="text" class="form-control" id="verifyCode">
      </div>

      <button id="loginBtn" class="btn btn-primary w-100" onclick="login()">登入</button>
      <button id="registerBtn" class="btn btn-success w-100 hide" onclick="register()">註冊</button>

      <div class="text-center mt-3">
        <a href="#" id="toggleAuth" onclick="toggleMode(event)">尚未註冊？點此註冊</a>
      </div>
    </div>
  </div>

  <!-- 主要面板 -->
  <div id="mainPanel" class="hide" style="margin-bottom: 4rem;">
    <h3 class="mb-4">管理控制台</h3>
    <ul class="nav nav-tabs" id="tabMenu" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="drink-tab" data-bs-toggle="tab" data-bs-target="#drink" type="button" role="tab">飲料異動</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="cust-tab" data-bs-toggle="tab" data-bs-target="#cust" type="button" role="tab">顧客管理</button>
      </li>
      
    </ul>
    <div class="tab-content p-3 border border-top-0" id="tabContent">
      <!-- 顧客管理 -->
      <div class="tab-pane fade" id="cust" role="tabpanel">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">顧客代號 (手機)</label>
            <input type="text" class="form-control" id="newCustId">
          </div>
          <div class="col-md-4">
            <label class="form-label">顧客姓名</label>
            <input type="text" class="form-control" id="newCustName">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" onclick="createCustomer()">建立顧客</button>
          </div>
        </div>
      </div>
      <hr class="my-3">
      <!-- 顧客搜尋 -->
      <div class="row g-3 align-items-end d-none" id="custSearch">
        <div class="col-md-4">
          <input type="text" class="form-control" id="custFilter" placeholder="搜尋顧客 (可留空顯示全部)">
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary w-100" onclick="searchCustomers()">搜尋</button>
        </div>
      </div>
      <div class="mt-3 d-none" id="custList"></div>
      <!-- 飲料異動 -->
      <div class="tab-pane fade show active" id="drink" role="tabpanel">
        <div class="row g-3 align-items-end mb-3">
          <div class="col-md-4">
            <label class="form-label">顧客代號或姓名</label>
            <input type="text" class="form-control" id="dCustId" placeholder="輸入顧客代號或姓名">
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100 mt-4" onclick="loadCustomer()">查詢</button>
          </div>
          <div class="col-md-2 ms-auto text-end">
            <button class="btn btn-outline-primary mt-4" id="shareBtn" style="display:none" onclick="genLink()">產生連結(QR)</button>
          </div>
        </div>
        <div id="drinkInfo" class="mb-4"></div>
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0" id="historyHeader" style="cursor:pointer">歷史異動</h6>
          </div>
          <div class="card-body p-2">
            <div id="historyList"></div>
            <div class="text-center my-2"><button id="moreBtn" class="btn btn-outline-secondary btn-sm" style="display:none">查看更多</button></div>
          </div>
        </div>
        <div class="p-3 border rounded bg-light mb-3">
          <h6 class="mb-3">新增品項</h6>
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">飲料名稱</label>
              <input type="text" class="form-control" id="drinkName" list="drinkSuggestions">
              <div class="form-check mt-1"><input class="form-check-input" type="checkbox" id="cupChk"><label class="form-check-label" for="cupChk">隨行杯</label></div>
              <datalist id="drinkSuggestions"></datalist>
            </div>
            <div class="col-md-2">
              <label class="form-label">數量</label>
              <input type="number" class="form-control" id="drinkAmt" value="1" step="1" inputmode="numeric" pattern="-?[0-9]*">
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-primary w-100 mt-4" id="drinkSubmitBtn" onclick="createDrink()">新增品項</button>
            </div>
          </div>
        </div>
        <div class="mt-3" id="linkGroup">
            <input type="text" id="linkOutput" class="form-control hide" readonly placeholder="產生的連結將顯示於此" style="cursor:pointer" title="點擊複製">
          </div>
          <!-- Toast Element -->
          <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="1500">
            <div class="toast-body">
              已複製連結！
            </div>
          </div>
        <!-- QR code -->
        <div class="text-center mt-3 d-flex justify-content-center"><img id="qrImg" class="d-none" style="max-width:180px; cursor:pointer" alt="QR Code" title="點擊複製連結"></div>
      </div>
    </div>
  </div>
</div>

<!-- 修改個人資料 Modal -->
<div class="modal fade" id="editAdminModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">修改個人資料</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">顯示名稱</label>
          <input type="text" class="form-control" id="editDisplayName">
        </div>
        <div class="mb-3">
          <label class="form-label">新密碼</label>
          <input type="password" class="form-control" id="editNewPwd">
        </div>
        <div class="mb-3">
          <label class="form-label">舊密碼（驗證）</label>
          <input type="password" class="form-control" id="editOldPwd">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="updateMe()">儲存</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="loading" class="position-fixed top-0 start-0 w-100 h-100 justify-content-center align-items-center bg-white bg-opacity-75" style="z-index:1060; display:none">
  <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
</div>


<script>

let historyOffset=0,historyHasMore=false, currentCustomer='';
let historyCollapsed=false;
function updateHistoryCollapse(){
  const items=document.querySelectorAll('#historyList .hist-item');
  items.forEach((el,idx)=>{
    if(idx<5) return; // 前 5 筆永遠顯示
    if(historyCollapsed){
      // 要收合：只有顯示中的才 slideUp
      if(!el.classList.contains('d-none')){
        $(el).slideUp(200,()=>el.classList.add('d-none'));
      }
    }else{
      // 要展開：先移除 d-none 再 slideDown
      if(el.classList.contains('d-none')){
        el.classList.remove('d-none');
        $(el).hide().slideDown(200);
      }
    }
  });
  document.getElementById('moreBtn').style.display = historyCollapsed? 'inline-block': (historyHasMore?'inline-block':'none');
}

// 監聽數量輸入變化，動態更新按鈕文字
document.getElementById('drinkAmt').addEventListener('input', function() {
  const amount = parseInt(this.value) || 0;
  const btn = document.getElementById('drinkSubmitBtn');
  if (amount < 0) {
    btn.textContent = '減少品項';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-warning');
  } else {
    btn.textContent = '新增品項';
    btn.classList.remove('btn-warning');
    btn.classList.add('btn-primary');
  }
});

function toggleHistoryCollapse(){
  historyCollapsed = !historyCollapsed;
  updateHistoryCollapse();
}
document.addEventListener('DOMContentLoaded',()=>{
  const hdr=document.getElementById('historyHeader');
  if(hdr) hdr.addEventListener('click',toggleHistoryCollapse);
});

function renderRemain(remainArr){
  const div=document.getElementById('drinkInfo');
  if(remainArr.length===0){div.innerHTML='<p>尚無資料</p>';return;}
  let html='<div class="row g-3">';
  remainArr.forEach(([n,r])=>{
    html+=`<div class="col-md-3"><div class="card"><div class="card-body text-center"><h5>${n}</h5><p class="fs-4 mb-2">${r}</p><div class="d-flex justify-content-center"><button class="btn btn-sm btn-danger me-2" onclick="changeDrink(-1,'${n}')">減少(-1)</button><button class="btn btn-sm btn-success" onclick="changeDrink(1,'${n}')">增加(+1)</button></div></div></div></div>`;
  });
  html+='</div>';
  div.innerHTML=html;
}

function formatDateTime(isoStr){
  const d = new Date(isoStr);
  if(isNaN(d)) return isoStr;
  const weekday = ['日','一','二','三','四','五','六'][d.getDay()];
  const dateStr = d.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'/');
  const timeStr = d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false});
  return `${dateStr} (${weekday}) ${timeStr}`;
}

function appendHistory(list){
  const hist=document.getElementById('historyList');
  list.forEach(row=>{
    const [name,remain,time,op,act,amt]=row;
    const fmtTime = formatDateTime(time);
    const cls=act==='增加'?'border-start border-4 border-success':'border-start border-4 border-danger';
    const card=document.createElement('div');
    card.className=`card mb-2 hist-item ${cls}`;
    card.innerHTML=`<div class="card-body p-2"><div class="d-flex justify-content-between"><span>${fmtTime}</span><span>${op}</span></div><div>${act} ${name} ${amt} 杯，剩餘 ${remain}</div></div>`;
    hist.appendChild(card);
  });
}

async function fetchAndRenderSummary(offset,append){
  const res=await api('getCustomerSummary',{customerId:currentCustomer,offset,limit:5});
  if(!res.success){showMsg(res.msg,'danger');return;}
  if(!append){
    renderRemain(res.remain);
    document.getElementById('historyList').innerHTML='';
  }
  appendHistory(res.history);
  updateHistoryCollapse();
  historyHasMore=res.hasMore;
  document.getElementById('moreBtn').style.display= historyHasMore?'inline-block':'none';
}

document.getElementById('moreBtn').addEventListener('click',async()=>{
  if(historyCollapsed){ historyCollapsed=false; updateHistoryCollapse(); return;}
  setLoading(true);
  try{
    historyOffset+=5;
    await fetchAndRenderSummary(historyOffset,true);
  }catch(err){
    showMsg(err.message||'發生錯誤','danger');
  }finally{
    setLoading(false);
  }
});

window.renderDrinkInfo = async function(customerId){
  currentCustomer=customerId;
  historyOffset=0;
  await fetchAndRenderSummary(0,false);
}


/* 查詢顧客列表 */
window.searchCustomers = async function(){
  const listEl = document.getElementById('custList');
  setLoading(true);
  listEl.classList.remove('d-none');
  listEl.innerHTML = Array(6).fill('<div class="skeleton mb-2" style="height:20px;width:100%;"></div>').join('');
  try{
    const keyword = document.getElementById('custFilter').value.trim();
    const res = await api('listCustomers',{keyword});
    if(res.success){
      // listEl 已事先定義
      const arr = res.customers || [];
      if(arr.length===0){
        listEl.innerHTML = '<p class="text-muted">無符合顧客</p>';
      }else{
        let html = '<table class="table table-sm table-striped"><thead><tr><th>代號</th><th>姓名</th></tr></thead><tbody>';
        arr.forEach(([id,name])=>{ html += `<tr><td>${id}</td><td>${name}</td></tr>`; });
        html += '</tbody></table>';
        listEl.innerHTML = html;
      }
    }else showMsg(res.msg,'danger');
  }catch(e){ showMsg(e.message||'發生錯誤','danger'); }
  finally{ setLoading(false); }
};

window.buildSuggestions = function(data){
  const dl=document.getElementById('drinkSuggestions');
  if(!dl || !Array.isArray(data)) return;
  const set=new Set();
  for(let i=1;i<data.length;i++){
    const name=data[i][0];
    if(name) set.add(name);
  }
  dl.innerHTML=[...set].map(n=>`<option value="${n}"></option>`).join('');
}

// ------ input helpers ------
function syncCupByName(){
  const name=document.getElementById('drinkName').value.trim();
  document.getElementById('cupChk').checked = name.endsWith('(隨行杯)');
}
function syncNameByCup(){
  const input=document.getElementById('drinkName');
  let name=input.value.trim();
  const chk=document.getElementById('cupChk');
  if(chk.checked){
    if(!name.endsWith('(隨行杯)')){ input.value = name + '(隨行杯)'; }
  }else{
    if(name.endsWith('(隨行杯)')){ input.value = name.replace('(隨行杯)','').trim(); }
  }
}
document.getElementById('drinkName').addEventListener('input',syncCupByName);
document.getElementById('cupChk').addEventListener('change',syncNameByCup);
</script>

<!-- Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let isRegisterMode = false;
// === 自動填入已儲存帳密 ===
document.addEventListener('DOMContentLoaded', () => {
  const savedSession = localStorage.getItem('sessionData');
    if (savedSession) {
        try {
            const session = JSON.parse(savedSession);
            const now = Date.now();
            // 10 days expiry
            if (session && session.username && session.displayName && (now - session.ts < 10 * 24 * 60 * 60 * 1000)) {
                // 如果 session 有效，直接設定登入狀態，不需重新 api call
                setLoggedInState(session.username, session.displayName);
            } else {
                localStorage.removeItem('sessionData');
            }
        } catch (e) {
            localStorage.removeItem('sessionData');
        }
    }
});
window.toggleMode = function (e) {
  e.preventDefault();
  isRegisterMode = !isRegisterMode;
  const fadeDur = 150, slideDur = 250;
  if (isRegisterMode) {
    // Step1: fade out current text & login button
    $.when(
      $('#loginBtn, #toggleAuth, #authTitle').animate({opacity:0}, fadeDur)
    ).then(() => {
      $('#loginBtn').addClass('hide');
      // update texts
      $('#authTitle').text('管理員註冊');
      $('#toggleAuth').text('已有帳號？點此登入');
      // Step2: slide down register fields (still transparent)
      $('#vcodeGroup, #registerBtn')
        .removeClass('hide')
        .css({opacity:0, display:'none'})
        .slideDown(slideDur)
        .promise()
        .then(()=>{
          // Step3: fade in register fields & updated texts
          $('#vcodeGroup, #registerBtn, #toggleAuth, #authTitle').animate({opacity:1}, fadeDur);
        });
    });
  } else {
    // Step1: fade out register fields & texts
    $.when(
      $('#vcodeGroup, #registerBtn, #toggleAuth, #authTitle').animate({opacity:0}, fadeDur)
    ).then(()=>{
      // Step2: slide up and hide register fields
      $('#vcodeGroup, #registerBtn').slideUp(slideDur, function(){ $(this).addClass('hide'); });
      // update texts
      $('#authTitle').text('管理員登入');
      $('#toggleAuth').text('尚未註冊？點此註冊');
      // Step3: show login and fade in everything after slide
      setTimeout(()=>{
        $('#loginBtn').removeClass('hide').css('opacity',0);
        $('#loginBtn, #toggleAuth, #authTitle').animate({opacity:1}, fadeDur);
      }, slideDur);
    });
  }
  $('#authTitle').text(isRegisterMode ? '管理員註冊' : '管理員登入');
  $('#toggleAuth').text(isRegisterMode ? '已有帳號？點此登入' : '尚未註冊？點此註冊');
};
window.showMsg = function(txt,type='success'){
  const $el = $('#msg');
  $el.stop(true,true); // 清除未完成動畫
  $el.removeClass('hide')
     .attr('class', 'alert alert-'+type) // 同時更新 class
     .text(txt)
     .css('opacity',0)
     .animate({opacity:1},400)          // 淡入 400ms
     .delay(2500)                       // 停留 2.5 秒
     .animate({opacity:0},400,()=>{     // 淡出 400ms
       $el.addClass('hide');
     });
}





</script>
<script>
// === GAS API wrapper for static hosting ===
const GAS_URL='https://script.google.com/macros/s/AKfycby5saXxJToZqGJXrTPAusoVwoUYoBw9rcWWmRdNGZHz7YwfeeUYGoUcBZmLwDUN7-ATUg/exec';
function api(action,data={}){
  return $.post(GAS_URL,{action, data: JSON.stringify(data)})
          .then(res=>typeof res==='string'?JSON.parse(res):res);
}
// override functions
// 設定登入成功後的 UI 狀態
function setLoggedInState(username, displayName) {
    document.getElementById('authCard').classList.add('hide');
    document.getElementById('mainPanel').classList.remove('hide');
    currentUsername = username;
    currentDisplayName = displayName;
    document.getElementById('userLabel').innerText = `Hi~歡迎 ${displayName}`;
    document.getElementById('userBar').classList.remove('hide');
    document.getElementById('logoutBtn').classList.remove('d-none');
    // 儲存 session 資訊
    localStorage.setItem('sessionData', JSON.stringify({username, displayName, ts:Date.now()}));
}

window.login = async function(){
  setLoading(true);
  try{
    const username=document.getElementById('username').value.trim();
    const password=document.getElementById('password').value.trim();
    if(!username||!password){showMsg('需輸入完整資料','danger');return;}
    const res=await api('login',{username,password});
    if(res.success){
       setLoggedInState(res.username, res.displayName);
       showMsg('登入成功');
     }else showMsg(res.msg,'danger');
  }catch(err){
    showMsg(err.message||'發生錯誤','danger');
  }finally{
    setLoading(false);
  }
}
window.register = async function(){
  setLoading(true);
  try{
    const username=document.getElementById('username').value.trim();
    const password=document.getElementById('password').value.trim();
    const verifyCode=document.getElementById('verifyCode').value.trim();
    if (!username || !password || !verifyCode){showMsg('請輸入完整資料','danger');return;}
    const res=await api('register',{username,password,verifyCode});
    if(res.success){
      // 先結束本次 loading，再自動登入
      setLoading(false);
      await login();
      return;
    }
    else showMsg(res.msg,'danger');
  }catch(err){
    showMsg(err.message||'發生錯誤','danger');
  }finally{
    setLoading(false);
  }
}
// 登出
window.logout = function(){
  document.getElementById('mainPanel').classList.add('hide');
  document.getElementById('userBar').classList.add('hide');
  document.getElementById('authCard').classList.remove('hide');
  document.getElementById('userLabel').innerText='';
  document.getElementById('logoutBtn').classList.add('d-none');
  localStorage.removeItem('sessionData');
};

window.createCustomer = async function(){
  setLoading(true);
  try{
    const customerId=document.getElementById('newCustId').value.trim();
    const customerName=document.getElementById('newCustName').value.trim();
    if(!customerId || !customerName){showMsg('請輸入完整資料','danger');return;}
    const res=await api('createCustomer',{customerId,customerName});
    showMsg(res.msg,res.success?'success':'danger');
  }catch(err){
    showMsg(err.message||'發生錯誤','danger');
  }finally{
    setLoading(false);
  }
}

// 新增品項 (初始庫存)
window.createDrink = async function(){
  setLoading(true);
  try{
    const customerId=document.getElementById('dCustId').value.trim();
    let drinkName=document.getElementById('drinkName').value.trim();
  if(document.getElementById('cupChk').checked && !drinkName.endsWith('(隨行杯)')){
    drinkName += '(隨行杯)';
  }
  const amount=parseInt(document.getElementById('drinkAmt').value,10)||1;
  const operator=currentDisplayName;
  if(!customerId||!drinkName){showMsg('請輸入顧客與飲料','danger'); return;}
    // 先新增飲料，再取得最新摘要
    const res = await api('addDrink', {customerId, drinkName, amount, operator});
    const summary = await api('getCustomerSummary', {customerId, offset: 0, limit: 5});
    showMsg(res.msg,res.success?'success':'danger');
    if(summary && summary.success){
      renderRemain(summary.remain);
      document.getElementById('historyList').innerHTML = '';
      appendHistory(summary.history);
      updateHistoryCollapse();
      historyHasMore = summary.hasMore;
      document.getElementById('moreBtn').style.display = historyHasMore?'inline-block':'none';
    }
  }catch(err){
    showMsg(err.message||'發生錯誤','danger');
  }finally{
    setLoading(false);
  }
}
const setLoading=flag=>{
  const overlay=document.getElementById('loading');
  if(flag){overlay.style.display='flex';}
  else{overlay.style.display='none';}
};

// 函數：控制背景顏色閃爍
const flashBackgroundColor = (color, times = 3, interval = 1000) => {
  let counter = 0;

  // 設置 CSS 過渡效果，使顏色變換更平滑
  document.body.style.transition = `background-color 0.5s ease`;

  const flashInterval = setInterval(() => {
    // 切換背景顏色，使用淡入淡出效果
    document.body.style.backgroundColor = counter % 2 === 0 ? color : '';
    counter++;

    // 當閃爍次數達到指定次數，清除定時器
    if (counter >= times * 2) {
      clearInterval(flashInterval);
      document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--base-bg').trim() || '#f2f5f3';  // 回復淡灰底色
    }
  }, interval);
};

window.loadCustomer = async function(){
  setLoading(true);
  // skeleton placeholders
  document.getElementById('drinkInfo').innerHTML = `<div class="row g-3">${Array(4).fill(0).map(()=>`<div class=\"col-md-3\"><div class=\"card\"><div class=\"card-body text-center\"><div class=\"skeleton rounded-circle mx-auto mb-2\" style=\"width:40px;height:40px;\"></div><div class=\"skeleton mx-auto mb-1\" style=\"height:20px;width:60%;\"></div><div class=\"skeleton mx-auto\" style=\"height:20px;width:80%;\"></div></div></div></div>`).join('')}</div>`;
  document.getElementById('historyList').innerHTML = Array(5).fill('<div class="skeleton mb-2" style="height:24px;width:100%;"></div>').join('');
  document.getElementById('moreBtn').style.display='none';
  try{
    const customerId=document.getElementById('dCustId').value.trim();
    if(!customerId){ return; }
    const res=await api('getCustomerSummary',{customerId,offset:0,limit:5});
    if(!res.success){
      flashBackgroundColor('#fad9ee', 2, 500);
      showMsg(res.msg,'danger');
      // 移除先前載入的顧客資料，使錯誤狀態更明確
      document.getElementById('drinkInfo').innerHTML = '';
      document.getElementById('historyList').innerHTML = '';
      document.getElementById('moreBtn').style.display = 'none';
      document.getElementById('shareBtn').style.display = 'none';
      const dlClear = document.getElementById('drinkSuggestions');
      if(dlClear) dlClear.innerHTML='';
      return;
    }
    renderDrinkInfo(customerId);
    // suggestions build from remain + history
    const names=new Set();
    res.remain.forEach(([n])=>names.add(n));
    res.history.forEach(row=>names.add(row[0]));
    const dl=document.getElementById('drinkSuggestions');
    dl.innerHTML=[...names].map(n=>`<option value="${n}"></option>`).join('');
    document.getElementById('shareBtn').style.display='inline-block';

  }catch(err){
    showMsg(err.message||'發生錯誤','danger');
  }finally{
    setLoading(false);
  }
}
window.changeDrink = async function(sign,drink){
  setLoading(true);
  try{
    const customerId=document.getElementById('dCustId').value.trim();
  let drinkName;
    if(drink){
      drinkName = drink; // 直接使用卡片名稱，不使用 checkbox
    }else{
      drinkName = document.getElementById('drinkName').value.trim();
      const chk=document.getElementById('cupChk');
      if(chk.checked && !drinkName.endsWith('(隨行杯)')){
        drinkName += '(隨行杯)';
      }else if(!chk.checked && drinkName.endsWith('(隨行杯)')){
        drinkName = drinkName.replace('(隨行杯)','').trim();
      }
    }
  if(!drinkName){showMsg('請輸入或選擇飲料名稱','danger');return;}
  const amount=1;
  const operator=currentDisplayName;
  const action= sign>0 ? 'addDrink' :'reduceDrink';
    // 發送異動請求
    const res = await api(action, { customerId, drinkName, amount, operator });
    showMsg(res.msg, res.success ? 'success' : 'danger');

    // 如果操作成功，才繼續拉取最新摘要
    if (res.success) {
      const summary = await api('getCustomerSummary', { customerId, offset: 0, limit: 5 });
      
      if (summary && summary.success) {
        // 更新畫面，顯示最新摘要
        renderRemain(summary.remain); // 更新餘額
        document.getElementById('historyList').innerHTML = ''; // 清空歷史紀錄
        appendHistory(summary.history); // 添加最新歷史
        updateHistoryCollapse();
        historyHasMore = summary.hasMore;
        document.getElementById('moreBtn').style.display = historyHasMore ? 'inline-block' : 'none';
      } else {
        showMsg('摘要更新失敗', 'danger');
      }
    }
  }catch(err){
    showMsg(err.message||'發生錯誤','danger');
  }finally{
    setLoading(false);
  }
}
window.genLink = async function(){
  setLoading(true);
  try{
    const customerId=document.getElementById('dCustId').value.trim();
    const res=await api('generateTempLink',{customerId});
    if(res.success){
      const token = res.token || (res.url ? new URL(res.url).searchParams.get('token') : '');
      const basePath = location.pathname.endsWith('index.html') 
        ? location.pathname.replace('index.html', 'userView.html') 
        : location.pathname.replace(/\/$/, '') + '/userView.html';
      const url = location.origin + basePath + `?token=${token}`;
      document.getElementById('linkOutput').value=url;
      document.getElementById('qrImg').src=`https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(url)}`;
      document.getElementById('qrImg').classList.remove('d-none');
      showMsg('連結已產生');
      document.getElementById('linkOutput').classList.remove('hide');
    }else{
      showMsg(res.msg,'danger');
    }
  }catch(err){
    showMsg(err.message||'發生錯誤','danger');
  }finally{
    setLoading(false);
  }
}
</script>

<script>
let currentUsername='';
let currentDisplayName='';
// QR 點擊複製
// linkGroup 點擊時複製 linkOutput 的內容
const linkGroupEl = document.getElementById('linkGroup');
if (linkGroupEl) {
  linkGroupEl.addEventListener('click', () => {
    const val = document.getElementById('linkOutput').value.trim();  // 獲取 'linkOutput' 的值
    if (val) {
      navigator.clipboard.writeText(val).then(() => {
        // 顯示已複製的提示
        const toastEl = document.getElementById('copyToast');
        const toast = new bootstrap.Toast(toastEl);  // 使用 Bootstrap 的 Toast API
        toast.show();  // 顯示 Toast
      });
    }
  });
}

// 填入現有名稱
 document.getElementById('editAdminModal').addEventListener('show.bs.modal',()=>{
   document.getElementById('editDisplayName').value=currentDisplayName;
 });

 // === Enter key submission helpers ===
 const bindEnter = (selector, handler) => {
   document.querySelectorAll(selector).forEach(el => {
     el.addEventListener('keydown', e => {
       if (e.key === 'Enter') {
         e.preventDefault();
         handler();
       }
     });
   });
 };
 // Login / Register
 bindEnter('#username, #password', () => { if (!isRegisterMode) login(); });
 bindEnter('#verifyCode', () => { if (isRegisterMode) register(); });
 // Customer search
 bindEnter('#dCustId', loadCustomer);
 // Create customer
 bindEnter('#newCustId, #newCustName', createCustomer);
// Customer list search
bindEnter('#custFilter', searchCustomers);
// toggle customer search visibility with tab switch
$('#tabMenu button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
  const show = e.target.getAttribute('data-bs-target') === '#cust';
  $('#custSearch, #custList').toggleClass('d-none', !show);
});
// Create drink
bindEnter('#drinkAmt', createDrink);

// Update admin
bindEnter('#editOldPwd', updateMe);

// 更新自己
window.updateMe = async function(){
  const newName=document.getElementById('editDisplayName').value.trim();
  const newPwd=document.getElementById('editNewPwd').value.trim();
  const oldPwd=document.getElementById('editOldPwd').value.trim();
  if(!oldPwd){showMsg('需輸入舊密碼','danger');return;}
  setLoading(true);
  try{
    const res=await api('updateAdmin',{username:currentUsername,oldPassword:oldPwd,newPassword:newPwd,newName:newName});
    showMsg(res.msg,res.success?'success':'danger');
    if(res.success){
      if(newName){
        currentDisplayName=newName; 
        document.getElementById('userLabel').innerText=`Hi~歡迎 ${currentDisplayName}`;
        // 更新 localStorage 中的 sessionData
        const sessionData = JSON.parse(localStorage.getItem('sessionData') || '{}');
        if(sessionData && sessionData.username === currentUsername) {
          sessionData.displayName = newName;
          sessionData.ts = Date.now();
          localStorage.setItem('sessionData', JSON.stringify(sessionData));
        }
      }
      bootstrap.Modal.getInstance(document.getElementById('editAdminModal')).hide();
    }
  }catch(e){showMsg(e.message||'發生錯誤','danger');}
  finally{setLoading(false);}
};
</script>
</body>
</html>
